#include <Windows.h>
#include <stdio.h>
#include <stdlib.h>


int main(int argc, const char* argv[]) {
	if (argc < 2) {
		printf("Usage: %s <ProcessID>\n", argv[0]);
		return 1;
	}

	PROCESS_MITIGATION_CONTROL_FLOW_GUARD_POLICY Pmp = { 0 };

	HANDLE hProc = OpenProcess(MAXIMUM_ALLOWED, FALSE, atoi(argv[1]));
	if (hProc == NULL) {
		printf("Failed to open process. Error: %lu\n", GetLastError());
		return 1;
	}

	if (GetProcessMitigationPolicy(hProc, ProcessControlFlowGuardPolicy, &Pmp, sizeof(Pmp))) {

		if (Pmp.EnableControlFlowGuard) {
			printf("CFG is enabled\n");
		}
		else {

			printf("CFG is not enabled\n");
		}
	}
	else {

		printf("Failed to retrieve CFG policy. Error: %lu\n", GetLastError());
	}

	CloseHandle(hProc);
	return 0;
}


